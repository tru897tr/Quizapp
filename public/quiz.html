<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr·∫Øc nghi·ªám Python</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Work Sans', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            width: 100%;
            padding: 40px;
            animation: containerFadeIn 0.5s ease forwards;
        }

        @keyframes containerFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5em;
            background: linear-gradient(135deg, #1e3c72 0%, #7e22ce 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .user-info {
            background: linear-gradient(135deg, #7e22ce, #3b82f6);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(126, 34, 206, 0.3);
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            transition: opacity 0.3s ease, height 0.3s ease;
        }

        .stats.hidden {
            opacity: 0;
            height: 0;
            margin: 0;
            overflow: hidden;
        }

        .stat-box {
            background: linear-gradient(135deg, #7e22ce 0%, #3b82f6 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(126, 34, 206, 0.4);
            animation: statBoxPop 0.5s ease;
        }

        @keyframes statBoxPop {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .stat-box h3 {
            font-size: 0.9em;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .stat-box .value {
            font-size: 2em;
            font-weight: bold;
        }

        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #7e22ce 0%, #3b82f6 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .question-container {
            animation: questionSlide 0.4s ease;
        }

        @keyframes questionSlide {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .question {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 25px;
            padding: 20px;
            background: #f5f7fa;
            border-radius: 15px;
            border-left: 5px solid #7e22ce;
        }

        .options {
            display: grid;
            gap: 15px;
            margin-bottom: 25px;
        }

        .option {
            padding: 20px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            font-size: 1.1em;
        }

        .option:hover:not(.correct):not(.wrong):not(.disabled) {
            border-color: #7e22ce;
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(126, 34, 206, 0.2);
        }

        .option.correct {
            border-color: #4CAF50;
            background: #e8f5e9;
            animation: correctPulse 0.5s ease;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .option.wrong {
            border-color: #f44336;
            background: #ffebee;
            opacity: 0.5;
            cursor: not-allowed;
            animation: wrongShake 0.5s ease;
        }

        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .option.disabled {
            cursor: not-allowed;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        .nav-btn {
            flex: 1;
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .nav-btn.prev {
            background: #e0e0e0;
            color: #333;
        }

        .nav-btn.prev:hover:not(:disabled) {
            background: #d0d0d0;
            transform: translateY(-2px);
        }

        .nav-btn.next {
            background: linear-gradient(135deg, #7e22ce 0%, #3b82f6 100%);
            color: white;
        }

        .nav-btn.next:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(126, 34, 206, 0.4);
        }

        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .result-screen {
            text-align: center;
            animation: resultZoom 0.6s ease;
        }

        @keyframes resultZoom {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .trophy {
            font-size: 5em;
            margin: 20px 0;
            animation: trophyBounce 1s ease infinite;
        }

        @keyframes trophyBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .restart-btn {
            background: linear-gradient(135deg, #7e22ce 0%, #3b82f6 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(126, 34, 206, 0.4);
            margin: 10px;
        }

        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(126, 34, 206, 0.6);
        }

        .timer-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7e22ce 0%, #3b82f6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .timer-inner {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        /* Fullscreen mode styles */
        body.fullscreen-mode {
            padding: 0;
        }

        .fullscreen-mode .container {
            max-width: 100%;
            width: 100vw;
            height: 100vh;
            border-radius: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            margin: 0;
        }

        .fullscreen-mode .header {
            display: none;
        }

        .fullscreen-mode .progress-bar {
            margin-bottom: 15px;
        }

        .fullscreen-mode .question-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .fullscreen-mode .question {
            font-size: 2.8em;
            font-weight: bold;
            padding: 30px;
            margin-bottom: 20px;
            flex-shrink: 0;
            background: rgba(126, 34, 206, 0.1);
            border: 3px solid #7e22ce;
            text-align: center;
        }

        .fullscreen-mode .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 15px;
            flex: 1;
            margin-bottom: 15px;
        }

        .fullscreen-mode .option {
            font-size: 1.8em;
            font-weight: 600;
            padding: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 0;
            border-width: 4px;
        }

        .fullscreen-mode .option strong {
            font-size: 1.2em;
            margin-right: 10px;
        }

        .fullscreen-mode .options .option:nth-child(1) {
            background: linear-gradient(135deg, #FFD93D 0%, #FFA500 100%);
            border-color: #FF8C00;
        }

        .fullscreen-mode .options .option:nth-child(2) {
            background: linear-gradient(135deg, #F9ED69 0%, #F08A5D 100%);
            border-color: #E07B39;
        }

        .fullscreen-mode .options .option:nth-child(3) {
            background: linear-gradient(135deg, #6BCF7F 0%, #4CAF50 100%);
            border-color: #388E3C;
        }

        .fullscreen-mode .options .option:nth-child(4) {
            background: linear-gradient(135deg, #6DD5FA 0%, #2980B9 100%);
            border-color: #1F5F8B;
        }

        .fullscreen-mode .options .option.correct {
            border-color: #00C851;
            border-width: 6px;
            box-shadow: 0 0 30px rgba(0, 200, 81, 0.8);
        }

        .fullscreen-mode .options .option.wrong {
            border-color: #ff4444;
            border-width: 6px;
            opacity: 0.4;
        }

        .fullscreen-mode .navigation-buttons {
            flex-shrink: 0;
            gap: 20px;
        }

        .fullscreen-mode .nav-btn {
            font-size: 1.6em;
            padding: 20px 40px;
        }

        @media (max-width: 768px) {
            .fullscreen-mode .question {
                font-size: 1.8em;
                padding: 20px;
            }

            .fullscreen-mode .option {
                font-size: 1.3em;
                padding: 20px 15px;
            }

            .fullscreen-mode .nav-btn {
                font-size: 1.2em;
                padding: 15px 30px;
            }
        }

        @media (min-width: 1024px) {
            .container {
                max-width: 1000px;
                padding: 50px;
            }

            .header h1 {
                font-size: 3.5em;
            }

            .question {
                font-size: 2em;
                padding: 30px;
            }

            .option {
                font-size: 1.6em;
                padding: 30px;
            }

            .stat-box .value {
                font-size: 2.5em;
            }

            .nav-btn {
                font-size: 1.4em;
                padding: 20px 40px;
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }

            .header h1 {
                font-size: 1.8em;
            }
            
            .stats {
                flex-direction: column;
                gap: 15px;
            }

            .question {
                font-size: 1.1em;
            }

            .option {
                font-size: 1em;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Tr·∫Øc nghi·ªám Python</h1>
            <div class="user-info">
                üë§ <span id="username"></span>
                <button class="logout-btn" onclick="logout()">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>

        <div id="stats" class="stats">
            <div class="stat-box">
                <h3>C√¢u h·ªèi</h3>
                <div class="value"><span id="currentQ">1</span>/<span id="totalQ">35</span></div>
            </div>
            <div class="stat-box">
                <h3>Th·ªùi gian</h3>
                <div class="value" id="timer">00:00</div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>

        <div id="quizArea"></div>
    </div>

    <script>
        const questions = [
            { id: 1, question: "Python s·ª≠ d·ª•ng g√¨ ƒë·ªÉ x√°c ƒë·ªãnh kh·ªëi l·ªánh?", options: ["Kho·∫£ng tr·∫Øng th·ª•t ƒë·∫ßu d√≤ng", "D·∫•u ngo·∫∑c nh·ªçn {}", "D·∫•u ch·∫•m ph·∫©y ;", "D·∫•u g·∫°ch ngang ‚Äì"], correct: 0 },
            { id: 2, question: "L·ªánh n√†o d√πng ƒë·ªÉ in d·ªØ li·ªáu ra m√†n h√¨nh?", options: ["echo()", "output()", "print()", "show()"], correct: 2 },
            { id: 3, question: "ƒêo·∫°n m√£ if 5 > 3: c·∫ßn ƒëi·ªÅu g√¨ ƒë·ªÉ tr√°nh l·ªói?", options: ["Th·ª•t ƒë·∫ßu d√≤ng ph√≠a sau", "ƒê√≥ng ngo·∫∑c ; ·ªü cu·ªëi", "ƒê·∫∑t d·∫•u {} bao quanh", "Vi·∫øt th√™m d·∫•u nh√°y \"\""], correct: 0 },
            { id: 4, question: "C√¢u l·ªánh n√†o t·∫°o v√≤ng l·∫∑p 5 l·∫ßn?", options: ["for i in range(0, 6)", "for i in range(5)", "for i in 1..5", "loop (5)"], correct: 1 },
            { id: 5, question: "Trong Python, bi·∫øn d√πng ƒë·ªÉ l√†m g√¨?", options: ["L∆∞u tr·ªØ d·ªØ li·ªáu t·∫°m th·ªùi", "Ch·ª©a m√£ l·ªánh Python", "L∆∞u h√¨nh ·∫£nh v√† file", "T·∫°o th∆∞ m·ª•c m·ªõi"], correct: 0 },
            { id: 6, question: "L·ªánh n√†o d√πng ƒë·ªÉ nh·∫≠p d·ªØ li·ªáu t·ª´ ng∆∞·ªùi d√πng?", options: ["ask()", "input()", "receive()", "get()"], correct: 1 },
            { id: 7, question: "Trong l·ªánh print(\"Xin ch√†o\", 5+3), Python s·∫Ω:", options: ["Gh√©p chu·ªói v√† s·ªë l·∫°i th√†nh m·ªôt chu·ªói duy nh·∫•t", "In t·ª´ng ph·∫ßn theo th·ª© t·ª±", "Kh√¥ng cho ph√©p in chu·ªói v√† s·ªë", "B√°o l·ªói to√°n t·ª≠"], correct: 1 },
            { id: 8, question: "Sai l·∫ßm ph·ªï bi·∫øn n√†o th∆∞·ªùng g·∫∑p?", options: ["D√πng print thay b·∫±ng prnit", "Sai d·∫•u nh√°y k√©p", "Sai th·ª•t d√≤ng", "T·∫•t c·∫£ c√°c √Ω tr√™n"], correct: 3 },
            { id: 9, question: "L·ªánh n√†o m·ªü file ·ªü ch·∫ø ƒë·ªô ghi n·ªëi ti·∫øp kh√¥ng x√≥a n·ªôi dung?", options: ["open(\"x.txt\", \"a\")", "open(\"x.txt\", \"w\")", "open(\"x.txt\", \"r\")", "open(\"x.txt\", \"x\")"], correct: 0 },
            { id: 10, question: "Trong hi·ªáu ·ª©ng ch·ªØ ch·∫°y, time.sleep(0.1) c√≥ t√°c d·ª•ng g√¨?", options: ["L√†m ch∆∞∆°ng tr√¨nh d·ª´ng l·∫°i ch√∫t", "X√≥a m√†n h√¨nh tr∆∞·ªõc ƒë√≥", "T·∫°o th√™m m·ªôt d√≤ng m·ªõi", "TƒÉng t·ªëc in k√Ω t·ª±"], correct: 0 },
            { id: 11, question: "flush=True trong print() nghƒ©a l√† g√¨?", options: ["Gi·ªØ l·∫°i k√Ω t·ª±", "Bu·ªôc in ngay l·∫≠p t·ª©c", "X√≥a b·ªô nh·ªõ ƒë·ªám", "Kh√¥ng in g√¨ c·∫£"], correct: 1 },
            { id: 12, question: "Khi ch·∫°y Python b·∫±ng VS Code, ƒëu√¥i file ph·∫£i l√† g√¨?", options: [".exe", ".py", ".txt", ".cmd"], correct: 1 },
            { id: 13, question: "L·ªánh ki·ªÉm tra phi√™n b·∫£n Python tr√™n m√°y?", options: ["python version", "py --check", "python --version", "py.ver()"], correct: 2 },
            { id: 14, question: "Trong Termux, l·ªánh c√†i Python l√†:", options: ["pkg get python", "pkg install python", "install python now", "setup python"], correct: 1 },
            { id: 15, question: "enumerate(list, 1) d√πng ƒë·ªÉ l√†m g√¨?", options: ["T·∫°o s·ªë th·ª© t·ª± b·∫Øt ƒë·∫ßu t·ª´ 1", "ƒê·∫£o ng∆∞·ª£c danh s√°ch", "X√≥a ph·∫ßn t·ª≠ ƒë·∫ßu", "Chuy·ªÉn t√™n th√†nh s·ªë"], correct: 0 },
            { id: 16, question: "C√¢u l·ªánh n√†o g√°n gi√° tr·ªã cho bi·∫øn ƒë√∫ng chu·∫©n?", options: ["name == \"Tru\"", "name := \"Tru\"", "name = \"Tru\"", "set(name, \"Tru\")"], correct: 2 },
            { id: 17, question: "Python Shell ƒë∆∞·ª£c m·ªü b·∫±ng c√°ch n√†o?", options: ["G√µ python trong terminal", "Click file python.exe", "Nh·∫≠p shell.py", "Ch·∫°y runpython"], correct: 0 },
            { id: 18, question: "Khi th·ª•t ƒë·∫ßu d√≤ng sai, Python b√°o l·ªói g√¨?", options: ["SyntaxWrong", "IndentationError", "SpaceFault", "TabMismatch"], correct: 1 },
            { id: 19, question: "L·ªánh while n√†o ƒë√∫ng c√∫ ph√°p?", options: ["while x < 5", "while (x < 5) do", "while x < 5:", "do while (x<5)"], correct: 2 },
            { id: 20, question: "ƒê·ªÉ ghi v√†o file v√† ƒë√≥ng sau khi ghi xong, ta d√πng:", options: ["f.open(); f.print();", "open(); write(); stop();", "f = open(...); f.write(...); f.close()", "createfile(); end();"], correct: 2 },
            { id: 21, question: "C√¢u l·ªánh n√†o KH√îNG ph·∫£i l√† l·ªánh xu·∫•t d·ªØ li·ªáu trong Python?", options: ["print()", "format()", "f-string", "output()"], correct: 3 },
            { id: 22, question: "Khi vi·∫øt name = input(\"T√™n: \"), ki·ªÉu d·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c l√† g√¨?", options: ["S·ªë nguy√™n", "Chu·ªói", "T·ª± ƒë·ªông nh·∫≠n d·∫°ng", "Ki·ªÉu boolean"], correct: 1 },
            { id: 23, question: "L·ªánh n√†o v·ª´a m·ªü file v·ª´a ghi ƒë√® to√†n b·ªô n·ªôi dung c≈©?", options: ["open(\"file.txt\", \"w\")", "open(\"file.txt\", \"a\")", "open(\"file.txt\", \"r\")", "open(\"file.txt\", \"wa\")"], correct: 0 },
            { id: 24, question: "Python b√°o l·ªói khi n√†o?", options: ["Vi·∫øt print sai ch√≠nh t·∫£", "Sai th·ª•t d√≤ng", "Thi·∫øu d·∫•u nh√°y", "T·∫•t c·∫£ c√°c l√Ω do tr√™n"], correct: 3 },
            { id: 25, question: "Trong c·∫•u tr√∫c if‚Äìelse, ph·∫ßn else ƒë∆∞·ª£c th·ª±c thi khi:", options: ["ƒêi·ªÅu ki·ªán ƒë√∫ng", "ƒêi·ªÅu ki·ªán sai", "ƒêi·ªÅu ki·ªán kh√¥ng t·ªìn t·∫°i", "C·∫£ 2 t√¨nh hu·ªëng ƒë√∫ng & sai"], correct: 1 },
            { id: 26, question: "range(3) t·∫°o ra nh·ªØng gi√° tr·ªã n√†o?", options: ["1, 2, 3", "0, 1, 2", "0, 1, 2, 3", "1, 2"], correct: 1 },
            { id: 27, question: "D√≤ng l·ªánh n√†o KH√îNG g√¢y l·ªói?", options: ["age = int(\"17\")", "age = int(\"m∆∞·ªùi b·∫£y\")", "age = int(\"17a\")", "age = int(\"\")"], correct: 0 },
            { id: 28, question: "Khi d√πng f-string, c√∫ ph√°p ƒë√∫ng l√†:", options: ["f(\"T√™n: {a}\")", "f\"Hello {name}\"", "f{'Tu·ªïi: {age}'}", "f<\"D·ªØ li·ªáu: {x}\">"], correct: 1 },
            { id: 29, question: "L·ªánh n√†o d√πng ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng in t·ª´ng ch·ªØ?", options: ["print(char, flush=0)", "print(char, end=\"\", flush=True)", "print(end=\"\", char, True)", "print(flush=\"\")"], correct: 1 },
            { id: 30, question: "Mu·ªën Python th·ª±c thi file tesst.py, ta d√πng:", options: ["py run tesst", "python tesst.py", "start tesst", "run.py tesst"], correct: 1 },
            { id: 31, question: "C√¢u l·ªánh n√†o v·ª´a t·∫°o file m·ªõi v·ª´a b√°o l·ªói n·∫øu file ƒë√£ t·ªìn t·∫°i?", options: ["open(\"a.txt\", \"w\")", "open(\"a.txt\", \"x\")", "open(\"a.txt\", \"a\")", "open(\"a.txt\", \"t\")"], correct: 1 },
            { id: 32, question: "Khi m·ªü Python Shell, d·∫•u nh·∫Øc l·ªánh xu·∫•t hi·ªán d∆∞·ªõi d·∫°ng:", options: [">>>", ":::", "...", "###"], correct: 0 },
            { id: 33, question: "Trong v√≤ng l·∫∑p while, n·∫øu qu√™n tƒÉng gi√° tr·ªã bi·∫øn, ƒëi·ªÅu g√¨ x·∫£y ra?", options: ["V√≤ng l·∫∑p ch·∫°y ƒë√∫ng 1 l·∫ßn", "B√°o l·ªói logic", "V√≤ng l·∫∑p v√¥ h·∫°n", "M√°y t·ª± s·ª≠a v√† ti·∫øp t·ª•c"], correct: 2 },
            { id: 34, question: "L·ªánh n√†o d√πng ƒë·ªÉ chuy·ªÉn chu·ªói sang s·ªë nguy√™n?", options: ["convert(str)", "int()", "number()", "parse()"], correct: 1 },
            { id: 35, question: "M·ªôt bi·∫øn h·ª£p l·ªá trong Python KH√îNG ƒë∆∞·ª£c b·∫Øt ƒë·∫ßu b·∫±ng:", options: ["Ch·ªØ c√°i", "D·∫•u g·∫°ch d∆∞·ªõi _", "Ch·ªØ s·ªë", "K√Ω t·ª± th∆∞·ªùng"], correct: 2 }
        ];

        let currentQuestion = 0;
        let startTime = Date.now();
        let timerInterval;
        let questionStartTime = Date.now();
        let timePerQuestion = [];
        let userAnswers = {};
        let shuffledQuestions = [];

        function initializeQuestions() {
            shuffledQuestions = questions.map(q => {
                const indices = [0, 1, 2, 3];
                for (let i = indices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [indices[i], indices[j]] = [indices[j], indices[i]];
                }
                
                const shuffledOptions = indices.map(i => q.options[i]);
                const newCorrectIndex = indices.indexOf(q.correct);
                
                return {
                    ...q,
                    options: shuffledOptions,
                    correct: newCorrectIndex
                };
            });
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timer').textContent = 
                    String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
            }, 1000);
        }

        function displayQuestion() {
            const q = shuffledQuestions[currentQuestion];
            const userAnswer = userAnswers[currentQuestion];
            
            document.getElementById('currentQ').textContent = currentQuestion + 1;
            document.getElementById('totalQ').textContent = questions.length;
            document.getElementById('progress').style.width = 
                ((currentQuestion) / questions.length) * 100 + '%';

            const quizArea = document.getElementById('quizArea');
            
            let optionsHTML = '';
            for (let idx = 0; idx < q.options.length; idx++) {
                let classes = 'option';
                let clickable = true;
                
                if (userAnswer !== undefined) {
                    if (idx === q.correct) {
                        classes += ' correct';
                    }
                    if (userAnswer.wrongAttempts && userAnswer.wrongAttempts.includes(idx)) {
                        classes += ' wrong';
                    }
                    if (userAnswer.correctAnswer !== undefined) {
                        classes += ' disabled';
                        clickable = false;
                    }
                }
                
                const onclickAttr = clickable ? 'onclick="checkAnswer(' + idx + ')"' : '';
                optionsHTML += '<div class="' + classes + '" ' + onclickAttr + '>';
                optionsHTML += '<strong>' + String.fromCharCode(65 + idx) + '.</strong> ' + q.options[idx];
                optionsHTML += '</div>';
            }

            const isAnswered = userAnswer && userAnswer.correctAnswer !== undefined;
            const prevDisabled = currentQuestion === 0 ? 'disabled' : '';
            const nextDisabled = !isAnswered ? 'disabled' : '';
            
            quizArea.innerHTML = '<div class="question-container">' +
                '<div class="question"><strong>C√¢u ' + (currentQuestion + 1) + ':</strong> ' + q.question + '</div>' +
                '<div class="options">' + optionsHTML + '</div>' +
                '<div class="navigation-buttons">' +
                    '<button class="nav-btn prev" onclick="prevQuestion()" ' + prevDisabled + '>‚Üê Quay l·∫°i</button>' +
                    '<button class="nav-btn next" onclick="nextQuestion()" ' + nextDisabled + '>Ti·∫øp t·ª•c ‚Üí</button>' +
                '</div>' +
            '</div>';
        }

        function checkAnswer(selected) {
            const q = shuffledQuestions[currentQuestion];
            const userAnswer = userAnswers[currentQuestion] || { wrongAttempts: [] };
            
            if (userAnswer.correctAnswer !== undefined) return;
            if (userAnswer.wrongAttempts.includes(selected)) return;
            
            const options = document.querySelectorAll('.option');
            
            if (selected === q.correct) {
                options[selected].classList.add('correct');
                
                const questionTime = Math.floor((Date.now() - questionStartTime) / 1000);
                timePerQuestion[currentQuestion] = questionTime;
                
                userAnswers[currentQuestion] = {
                    ...userAnswer,
                    correctAnswer: selected
                };
                
                options.forEach(opt => opt.classList.add('disabled'));
                
                const nextBtn = document.querySelector('.nav-btn.next');
                nextBtn.disabled = false;
                
            } else {
                options[selected].classList.add('wrong');
                userAnswer.wrongAttempts.push(selected);
                userAnswers[currentQuestion] = userAnswer;
                
                options[selected].style.pointerEvents = 'none';
            }
        }

        function prevQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                questionStartTime = Date.now();
                displayQuestion();
            } else {
                showResults();
            }
        }

        async function showResults() {
            clearInterval(timerInterval);
            const totalTime = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(totalTime / 60);
            const seconds = totalTime % 60;

            const validTimes = timePerQuestion.filter(t => t !== undefined);
            const avgTime = validTimes.length > 0 ? Math.floor(validTimes.reduce((a, b) => a + b, 0) / validTimes.length) : 0;
            const fastestTime = validTimes.length > 0 ? Math.min(...validTimes) : 0;
            const slowestTime = validTimes.length > 0 ? Math.max(...validTimes) : 0;

            // Save result to server
            try {
                const token = localStorage.getItem('token');
                await fetch('/api/save-result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        totalTime,
                        avgTime,
                        fastestTime,
                        slowestTime
                    })
                });
            } catch (error) {
                console.error('Error saving result:', error);
            }

            document.getElementById('stats').style.display = 'none';
            document.querySelector('.progress-bar').style.display = 'none';
            
            document.getElementById('quizArea').innerHTML = 
                '<div class="result-screen">' +
                    '<div class="trophy">üèÜ</div>' +
                    '<h2 style="font-size: 2em; margin-bottom: 10px; color: #333;">Ch√∫c m·ª´ng!</h2>' +
                    '<p style="font-size: 1.2em; color: #666; margin-bottom: 30px;">B·∫°n ƒë√£ ho√†n th√†nh b√†i tr·∫Øc nghi·ªám</p>' +
                    '<div class="timer-circle">' +
                        '<div class="timer-inner">' +
                            '<span style="color: #7e22ce;">' + minutes + ':' + String(seconds).padStart(2, '0') + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div style="background: #f5f7fa; padding: 30px; border-radius: 20px; margin: 20px 0;">' +
                        '<h3 style="color: #7e22ce; margin-bottom: 20px;">üìä Th·ªëng k√™ chi ti·∫øt</h3>' +
                        '<div style="display: grid; gap: 15px; text-align: left;">' +
                            '<div style="padding: 15px; background: white; border-radius: 10px;">' +
                                '<strong>‚è±Ô∏è T·ªïng th·ªùi gian:</strong> ' + minutes + ' ph√∫t ' + seconds + ' gi√¢y' +
                            '</div>' +
                            '<div style="padding: 15px; background: white; border-radius: 10px;">' +
                                '<strong>üìà Th·ªùi gian trung b√¨nh/c√¢u:</strong> ' + avgTime + ' gi√¢y' +
                            '</div>' +
                            '<div style="padding: 15px; background: white; border-radius: 10px;">' +
                                '<strong>‚ö° C√¢u nhanh nh·∫•t:</strong> ' + fastestTime + ' gi√¢y' +
                            '</div>' +
                            '<div style="padding: 15px; background: white; border-radius: 10px;">' +
                                '<strong>üê¢ C√¢u ch·∫≠m nh·∫•t:</strong> ' + slowestTime + ' gi√¢y' +
                            '</div>' +
                            '<div style="padding: 15px; background: white; border-radius: 10px;">' +
                                '<strong>‚úÖ T·ªïng s·ªë c√¢u:</strong> ' + questions.length + ' c√¢u' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    '<button class="restart-btn" onclick="location.reload()">üîÑ L√†m l·∫°i b√†i test</button>' +
                    '<button class="restart-btn" onclick="logout()">üö™ ƒêƒÉng xu·∫•t</button>' +
                '</div>';
        }

        // Fullscreen functionality (triggered by F11 or browser fullscreen)
        document.addEventListener('fullscreenchange', function() {
            if (document.fullscreenElement) {
                document.getElementById('stats').classList.add('hidden');
                document.body.classList.add('fullscreen-mode');
            } else {
                document.getElementById('stats').classList.remove('hidden');
                document.body.classList.remove('fullscreen-mode');
            }
        });

        async function logout() {
            const token = localStorage.getItem('token');
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            window.location.href = '/';
        }

        // Check authentication
        window.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');

            if (!token) {
                window.location.href = '/';
                return;
            }

            try {
                const response = await fetch('/api/verify', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    window.location.href = '/';
                    return;
                }

                document.getElementById('username').textContent = username;
                initializeQuestions();
                displayQuestion();
                startTimer();
            } catch (error) {
                window.location.href = '/';
            }
        });
    </script>
</body>
</html>
